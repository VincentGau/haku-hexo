---
title: Identity用户体系和授权认证
date: 2018-06-22 09:30:35
tags:
- asp.net
- WIF
- identity
- authentication
- authorization
---

大多数Web 应用都有用户的存在，有用户就必然涉及到授权和认证来控制用户行为，一些不允许匿名访问的资源（如webapi）也需要授权和认证，系统验证了用户身份的合法性之后用户才可以访问资源。这里分两步：认证（Authentication）验证用户的身份；授权（Authorization）验证用户是否有正确的权限获取指定的资源；授权、认证过程可以直接集成到单个应用程序中，对于由众多应用程序形成的生态系统，为其中每一个应用程序都开发自己的用户体系无疑是重复造轮子，而且会随之产生巨大的运维压力，用户信息的新增、撤销和修改需要在多处同时处理，若再有和外部系统对接的需求，则是一件更为复杂的事情，因此需要将用户授权认证模块从应用程序剥离，作为一个独立的模块供多个系统共用，基于声明的联合授权认证是一个可行的方案。
# 基于声明的授权认证
联合安全模型和基于声明的授权和认证并不是新的概念，在联合安全模型中认证和授权过程与应用程序本身分开，认证和授权是另外的单独的Web服务，即安全令牌服务（Security Token Service, STS），STS负责颁发安全令牌；信赖方应用程序不关心认证方如何认证，在认证方认证成功之后返回一个令牌，令牌中包含了信赖方需要的用户名、角色、权限等用来认证用户身份的信息。这种方式避免了针对一个用户需要设置和管理重复账号的情况，并且能满足单点登录（SSO）的场景。
## 认证过程
在基于声明的应用场景中，通常包含三方参与者，分别是：应用程序自身，终端用户和STS。
{% asset_img wifbasicwebapp.gif %}
1. 用户访问依赖方应用程序，依赖方应用程序发现该未经认证的请求，于是重定向到STS 服务；
2. STS 服务需要用户提供凭证以验证身份，认证成功之后STS 会颁发一个令牌给用户；
3. 带着这个令牌，用户会被STS 服务重定向到依赖方应用程序；
4. 依赖方应用程序提前通过配置信任该STS 和它颁发的令牌，它会取出令牌中的声明信息，实现用户验证；  
也就是说，在依赖方与STS服务建立起信任关系之后，当用户请求依赖方应用的资源时，依赖方应用程序不关心登录过程，不关心用户角色，只需要把用户重定向到STS，由STS作验证和返回令牌，依赖方应用程序从令牌中获取需要的信息。

下面以一个具体场景，进一步理解基于声明的认证模型：
场景中涉及两个应用：一个是我们自己的系统A，需要用户登录后访问；一个是用户管理系统，用户数据保存在这里，也在这里对用户信息进行增删改查，同时STS也包含在这个系统中；
1. 用户访问系统A的资源；
2. 如果已有登录凭据则直接进入访问对应资源；如果没有登录凭据，则跳转向用户管理系统的STS服务请求安全令牌，并在请求中附带来源信息以便在登录之后重新跳转回去；
3. 用户在用户管理系统登录页面输入用户名和密码，

## 名词解释
**声明**是标识信息描述，如：用户名，部门，角色信息等。身份提供者验证成功后会返回一组声明，信赖方应用程序根据声明进行授权；建立基于声明的应用程序后，应用程序中的用户身份将通过一组声明来表示，一个声明可能是用户名，也可能是邮箱地址等等；  
**令牌**是声明传输的载体，是发行机构（STS）签名的一组序列化的声明；  
**STS**，安全令牌服务，一个负责认证用户并颁发令牌的服务，它把声明打包进令牌，对令牌进行加密；  
**依赖方应用程序**即依赖声明的应用程序，它将用户认证逻辑代理出去给STS，提取STS 颁发的令牌中的声明并将它们用于身份验证；  

和基于角色的模型相比，基于声明的方式不与角色捆绑，具有更好的灵活性和扩展性，声明并不局限于角色和权限，还能附带用户的其他信息，比如邮箱、生日，比如还可以通过isOver18 声明在不透露用户具体年龄的情况下验证用户是否有权限等等。

# 基于声明的模式的实现
Windows Identity Framework（WIF）是一组.Net Framework 类库，实现身份感知的（Identity-aware）、基于声明（Claim-based）的应用程序和服务，WIF 原本是作为独立下载的类库发布的，现已经集成到.Net 4.5 中。

Identity 是微软在ASP.NET 应用程序中管理用户的一个API。

基于声明的联合认证方式具有以下特点：
- 将身份验证机制从应用程序和服务中分离出来，实现与应用程序的松耦合；
- 使用声明（Claim）代替角色（Role），声明是一种更灵活、更精确的对象，它可以包括角色及其他信息；
- 授予受信任的域访问应用程序的权限；

# 如何建立STS

# 小结

应用场景 流程
