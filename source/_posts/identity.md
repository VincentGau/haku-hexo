---
title: Identity用户体系和授权认证
date: 2018-06-22 09:30:35
tags:
- asp.net
- WIF
- identity
- authentication
- authorization
---

大多数Web 应用都有用户的存在，有用户就必然涉及到授权和认证来控制用户行为，一些不允许匿名访问的资源（如webapi）也需要授权和认证，系统验证了用户身份的合法性之后用户才可以访问资源。这里分两步：认证（Authentication）验证用户的身份；授权（Authorization）验证用户是否有正确的权限获取指定的资源；授权、认证过程可以直接集成到单个应用程序中，对于由众多应用程序形成的生态系统，为其中每一个应用程序都开发自己的用户体系无疑是重复造轮子，而且会随之产生巨大的运维压力，用户信息的新增、撤销和修改需要在多处同时处理，若再有和外部系统对接的需求，则是一件更为复杂的事情，因此需要将用户授权认证模块从应用程序剥离，作为一个独立的模块供多个系统共用，基于声明的联合授权认证是一个可行的方案。
# 基于声明的授权认证
将认证和授权过程与登录代码分开，认证和授权是另外的单独的Web服务；信赖方应用程序不关心认证方如何认证，在认证方认证成功之后返回一个令牌，令牌中包含了信赖方需要的用户名、角色等信息；在基于声明的应用场景中，通常包含三方参与者，分别是：应用程序自身，终端用户，安全令牌服务（Security Token Service, STS）。
{% asset_img wifbasicwebapp.gif %}
1. 用户访问依赖方应用程序，依赖方应用程序发现该未经认证的请求，于是重定向到STS 服务；
2. STS 服务需要用户提供凭证以验证身份，认证成功之后STS 会颁发一个令牌给用户；
3. 带着这个令牌，用户会被STS 服务重定向到依赖方应用程序；
4. 依赖方应用程序提前通过配置信任该STS 和它颁发的令牌，它会取出令牌中的声明信息，实现用户验证；
声明是标识信息描述，如：用户名，部门，角色信息等。身份提供者验证成功后会返回一组声明，信赖方应用程序根据声明进行授权；建立基于声明的应用程序后，应用程序中的用户身份将通过一组声明来表示，一个声明可能是用户名，也可能是邮箱地址等等；
令牌：令牌是声明传输的载体，是发行机构（STS）签名的一组序列化的声明；
STS，安全令牌服务，一个负责认证用户并颁发令牌的服务，它把声明打包进令牌，对令牌进行加密；
依赖方应用程序即依赖声明的应用程序，它将用户认证逻辑代理出去给STS，提取STS 颁发的令牌中的声明并将它们用于身份验证；
和基于角色的模型相比，有和区别
在联合安全模型中，认证通过Security Token Service（STS）实现，STS颁发安全令牌
Windows Identity Framework（WIF）是一组.Net Framework 类库，实现身份感知的（Identity-aware）、基于声明（Claim-based）的应用程序和服务，WIF 原本是作为独立下载的类库发布的，现已经集成到.Net 4.5 中，
Identity 是微软在ASP.NET 应用程序中管理用户的一个API。

基于声明的联合认证方式具有以下特点：
- 将身份验证机制从应用程序和服务中分离出来，实现与应用程序的松耦合；
- 使用声明（Claim）代替角色（Role），声明是一种更灵活、更精确的对象，它可以包括角色及其他信息；
- 授予受信任的域访问应用程序的权限；

# 如何建立STS

应用场景 流程
